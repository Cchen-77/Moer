\hypertarget{_bvh_8cpp_source}{}\doxysection{Bvh.\+cpp}
\label{_bvh_8cpp_source}\index{/mnt/renderer/Zero/src/FunctionLayer/Aggregate/Bvh.cpp@{/mnt/renderer/Zero/src/FunctionLayer/Aggregate/Bvh.cpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00012}00012 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_bvh_8h}{Bvh.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00013}00013 \textcolor{preprocessor}{\#define BVH\_BUILD\_ERROR false}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00014}00014 \textcolor{comment}{//build the BVH of entites within the interval [start, end)}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00015}00015 std::shared\_ptr<BvhTreeNode> Bvh::RecursiveBuild(std::vector<EntityInfo>\& entityInfo, \textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} end, \textcolor{keywordtype}{int}\& nodeNumber, std::vector<std::shared\_ptr<Entity>>\& orderedEntites) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00016}00016     nodeNumber++;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00017}00017     std::shared\_ptr<BvhTreeNode> root = std::make\_shared<BvhTreeNode>();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00018}00018     \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}} totalBounds;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00019}00019     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = start; i < end; i++) totalBounds = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(totalBounds, entityInfo[i].bounds);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00020}00020     root-\/>bounds = totalBounds;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00021}00021     \textcolor{keywordtype}{int} nEntities = end -\/ start;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00022}00022     \textcolor{keywordflow}{if} (nEntities == 1) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00023}00023         \textcolor{comment}{//leaf node}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00024}00024         root-\/>entityOffset = orderedEntites.size();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00025}00025         root-\/>nEntites = 1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00026}00026         orderedEntites.push\_back(entites[entityInfo[start].EntityId]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00027}00027     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00028}00028     \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00029}00029         \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}} centerBounds;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00030}00030         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = start; i < end; i++) centerBounds = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(centerBounds, \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}}(entityInfo[i].center));}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00031}00031         \textcolor{keywordtype}{int} dim = -\/1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00032}00032         \textcolor{keywordtype}{double} maxD = 0;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00033}00033         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00034}00034             \textcolor{keywordtype}{double} D = centerBounds.pMax[i] -\/ centerBounds.pMin[i];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00035}00035             \textcolor{keywordflow}{if} (maxD < D) maxD = D, dim = i;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00036}00036         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00037}00037         \textcolor{keywordflow}{if} (dim == -\/1) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00038}00038             \textcolor{comment}{//leaf node}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00039}00039             root-\/>entityOffset = orderedEntites.size();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00040}00040             root-\/>nEntites = nEntities;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00041}00041             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = start; i < end; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00042}00042                 orderedEntites.push\_back(entites[entityInfo[i].EntityId]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00043}00043             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00044}00044         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00045}00045         \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00046}00046             \textcolor{comment}{//interior node}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00047}00047             root-\/>splitAxis = dim;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00048}00048             \textcolor{keywordtype}{int} mid = (start + end) >> 1, success = 1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00049}00049 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00050}00050             \textcolor{keywordflow}{if} (splitMethod == SplitMethod::Middle) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00051}00051                 \textcolor{keywordtype}{double} pmid = 0.5 * (centerBounds.pMin[dim] + centerBounds.pMax[dim]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00052}00052                 mid = std::partition(entityInfo.begin() + start, entityInfo.begin() + end, [\&](\textcolor{keyword}{const} \mbox{\hyperlink{struct_entity_info}{EntityInfo}}\& pi) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00053}00053                     return pi.center[dim] < pmid;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00054}00054                 \}) -\/ entityInfo.begin();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00055}00055                 \textcolor{keywordflow}{if} (mid == start || mid == end) success = 0;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00056}00056             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00057}00057 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00058}00058             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (nEntities <= 2 || splitMethod == SplitMethod::EqualCounts) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00059}00059                 mid = (start + end) >> 1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00060}00060                 std::nth\_element(entityInfo.begin() + start, entityInfo.begin() + mid, entityInfo.begin() + end, [\&](\textcolor{keyword}{const} \mbox{\hyperlink{struct_entity_info}{EntityInfo}}\& a, \textcolor{keyword}{const} \mbox{\hyperlink{struct_entity_info}{EntityInfo}}\& b) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00061}00061                     return a.center[dim] < b.center[dim];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00062}00062                 \});}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00063}00063                 success = 1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00064}00064             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00065}00065 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00066}00066             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!success || splitMethod == SplitMethod::SAH) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00067}00067                 \textcolor{keyword}{const} \textcolor{keywordtype}{int} split = 30;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00068}00068                 std::vector<std::pair<int, BoundingBox3f>> bucketInfos(split);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00069}00069                 std::vector<BoundingBox3f> suffixBounds(split);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00070}00070                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = start; i < end; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00071}00071                     \textcolor{keywordtype}{int} bucket = split * (entityInfo[i].center[dim] -\/ centerBounds.pMin[dim]) / maxD;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00072}00072                     \textcolor{keywordflow}{if} (bucket == split) bucket-\/-\/;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00073}00073                     \textcolor{keyword}{auto}\& [count, bounds] = bucketInfos[bucket];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00074}00074                     count++;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00075}00075                     bounds = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(bounds, entityInfo[i].bounds);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00076}00076                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00077}00077                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = split -\/ 1; i >= 0; i-\/-\/) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00078}00078                     suffixBounds[i] = bucketInfos[i].second;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00079}00079                     \textcolor{keywordflow}{if} (i + 1 < split) suffixBounds[i] = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(suffixBounds[i], suffixBounds[i + 1]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00080}00080                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00081}00081                 \textcolor{keywordtype}{double} minCost = DBL\_MAX;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00082}00082                 \textcolor{keywordtype}{int} count0 = 0, minCostBucket = -\/1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00083}00083                 \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}} prefix;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00084}00084                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i + 1 < split; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00085}00085                     \textcolor{keyword}{const} \textcolor{keyword}{auto} [count, bounds] = bucketInfos[i];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00086}00086                     count0 += count;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00087}00087                     prefix = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(prefix, bounds);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00088}00088                     \textcolor{keywordtype}{double} costI = 1 + (count0 * prefix.\mbox{\hyperlink{class_bounding_box3_af4981b8f6cf5f772168080fd8c3fea59}{SurfaceArea}}() + (nEntities -\/ count0) * suffixBounds[i + 1].SurfaceArea()) / totalBounds.\mbox{\hyperlink{class_bounding_box3_af4981b8f6cf5f772168080fd8c3fea59}{SurfaceArea}}();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00089}00089                     \textcolor{keywordflow}{if} (minCost > costI) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00090}00090                         minCost = costI;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00091}00091                         minCostBucket = i;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00092}00092                     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00093}00093                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00094}00094                 \textcolor{keywordflow}{if} (minCost < nEntities) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00095}00095                     mid = std::partition(entityInfo.begin() + start, entityInfo.begin() + end, [\&](\textcolor{keyword}{const} \mbox{\hyperlink{struct_entity_info}{EntityInfo}}\& pi) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00096}00096                         int bucket = split * (pi.center[dim] -\/ centerBounds.pMin[dim]) / maxD;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00097}00097                         if (bucket == split) bucket-\/-\/;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00098}00098                         return bucket <= minCostBucket;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00099}00099                     \}) -\/ entityInfo.begin();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00100}00100                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00101}00101                 \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00102}00102                     \textcolor{comment}{//leaf node}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00103}00103                     mid = -\/1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00104}00104                     root-\/>entityOffset = orderedEntites.size();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00105}00105                     root-\/>nEntites = nEntities;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00106}00106                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = start; i < end; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00107}00107                         orderedEntites.push\_back(entites[entityInfo[i].EntityId]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00108}00108                     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00109}00109                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00110}00110             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00111}00111             \textcolor{keywordflow}{else} assert(BVH\_BUILD\_ERROR);\textcolor{comment}{//should not be here!!!}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00112}00112             \textcolor{keywordflow}{if} (mid != -\/1) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00113}00113                 assert(mid > start);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00114}00114                 root-\/>children[0] = RecursiveBuild(entityInfo, start, mid, nodeNumber, orderedEntites);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00115}00115                 root-\/>children[1] = RecursiveBuild(entityInfo, mid, end, nodeNumber, orderedEntites);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00116}00116             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00117}00117         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00118}00118     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00119}00119     \textcolor{keywordflow}{return} root;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00120}00120 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00121}00121 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00122}00122 \textcolor{keywordtype}{void} Bvh::Flatten(std::shared\_ptr<BvhTreeNode> node, \textcolor{keywordtype}{int}\& dfsOrder) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00123}00123     \textcolor{keywordflow}{if} (node == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00124}00124     \textcolor{keyword}{auto}\& lnode = linearBvhNodes[dfsOrder++];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00125}00125     lnode.bounds = node-\/>bounds;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00126}00126     \textcolor{keywordflow}{if} (node-\/>nEntites > 0) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00127}00127         \textcolor{comment}{//leaf}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00128}00128         lnode.firstdEntityOffset = node-\/>entityOffset;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00129}00129         lnode.nEntites = node-\/>nEntites;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00130}00130     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00131}00131     \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00132}00132         \textcolor{comment}{//interior}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00133}00133         lnode.splitAxis = node-\/>splitAxis;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00134}00134         Flatten(node-\/>children[0], dfsOrder);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00135}00135         lnode.secondChildOrder = dfsOrder;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00136}00136         Flatten(node-\/>children[1], dfsOrder);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00137}00137     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00138}00138 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00139}00139 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00140}00140 Bvh::Bvh(std::vector<std::shared\_ptr<Entity>>\& \_entites, SplitMethod \_splitMethod): entites(\_entites), splitMethod(\_splitMethod)\{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00141}00141     \textcolor{keywordflow}{if} (entites.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00142}00142 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00143}00143     std::vector<EntityInfo> entityInfo(entites.size());}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00144}00144     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < entites.size(); i++) entityInfo[i] = \mbox{\hyperlink{struct_entity_info}{EntityInfo}}(i, entites[i]-\/>WorldBound());}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00145}00145     std::vector<std::shared\_ptr<Entity>> orderedEntites;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00146}00146     \textcolor{keywordtype}{int} nodeNumber = 0;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00147}00147     std::shared\_ptr<BvhTreeNode> root = RecursiveBuild(entityInfo, 0, entityInfo.size(), nodeNumber, orderedEntites);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00148}00148 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00149}00149     entites.swap(orderedEntites);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00150}00150     entityInfo.resize(0);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00151}00151     }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00152}00152     \textcolor{keywordtype}{int} dfsOrder = 0;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00153}00153     linearBvhNodes.resize(nodeNumber);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00154}00154     Flatten(root, dfsOrder);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00155}00155 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00156}00156 }
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00157}00157 std::optional<Intersection> Bvh::Intersect(\textcolor{keyword}{const} \mbox{\hyperlink{struct_ray}{Ray}}\& r) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00158}00158     \textcolor{keywordflow}{if} (linearBvhNodes.empty()) \textcolor{keywordflow}{return} std::nullopt;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00159}00159     \mbox{\hyperlink{struct_ray}{Ray}} R(r);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00160}00160     \mbox{\hyperlink{struct_t_vector3}{Vec3d}} invDir(1 / r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[0], 1 / r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[1], 1 / r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[2]);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00161}00161     \textcolor{keywordtype}{bool} isNegDir[3] = \{ r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[0] < 0, r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[1] < 0, r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[2] < 0 \};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00162}00162     std::vector<int> nextNodeStack;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00163}00163     \textcolor{keywordtype}{int} currentNode = 0, flag = 0;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00164}00164     std::optional<Intersection> result;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00165}00165     \textcolor{keywordflow}{while} (\textcolor{keyword}{true}) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00166}00166         \textcolor{keyword}{auto}\& node = linearBvhNodes[currentNode];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00167}00167         \textcolor{keyword}{auto} boundingIts = node.bounds.Intersection(R);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00168}00168         \textcolor{keywordflow}{if} (boundingIts.has\_value()) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00169}00169             \textcolor{keywordflow}{if} (node.nEntites > 0) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00170}00170                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < node.nEntites; i++) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00171}00171                     \textcolor{keyword}{auto} its = entites[node.firstdEntityOffset + i]-\/>intersect(R);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00172}00172                     \textcolor{keywordflow}{if} (its.has\_value()) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00173}00173                         flag = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00174}00174                         \textcolor{keywordtype}{double} t = (its-\/>position[0] -\/ r.\mbox{\hyperlink{struct_ray_abbb355c9e163124a0b4f8ab0f73643bb}{origin}}[0]) / r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[0];}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00175}00175                         if (R.timeMax > t) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00176}00176                             R.timeMax = t;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00177}00177                             result = its;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00178}00178                         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00179}00179                     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00180}00180                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00181}00181                 \textcolor{keywordflow}{if} (nextNodeStack.empty()) \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00182}00182                 currentNode = nextNodeStack.back();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00183}00183                 nextNodeStack.pop\_back();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00184}00184             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00185}00185             \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00186}00186                 \textcolor{keywordflow}{if} (isNegDir[node.splitAxis]) \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00187}00187                     nextNodeStack.push\_back(currentNode + 1);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00188}00188                     currentNode = node.secondChildOrder;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00189}00189                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00190}00190                 \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00191}00191                     nextNodeStack.push\_back(node.secondChildOrder);}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00192}00192                     currentNode = currentNode + 1;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00193}00193                 \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00194}00194             \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00195}00195         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00196}00196         \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00197}00197             \textcolor{keywordflow}{if} (nextNodeStack.empty()) \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00198}00198             currentNode = nextNodeStack.back();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00199}00199             nextNodeStack.pop\_back();}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00200}00200         \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00201}00201     \}}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00202}00202     \textcolor{keywordflow}{return} flag? result: std::nullopt;}
\DoxyCodeLine{\Hypertarget{_bvh_8cpp_source_l00203}00203 \}}

\end{DoxyCode}
