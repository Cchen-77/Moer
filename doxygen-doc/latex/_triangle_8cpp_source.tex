\hypertarget{_triangle_8cpp_source}{}\doxysection{Triangle.\+cpp}
\label{_triangle_8cpp_source}\index{/mnt/renderer/Zero/src/FunctionLayer/Shape/Triangle.cpp@{/mnt/renderer/Zero/src/FunctionLayer/Shape/Triangle.cpp}}
\mbox{\hyperlink{_triangle_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00012}00012 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_triangle_8h}{Triangle.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00013}00013 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_intersection_8h}{FunctionLayer/Intersection.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00014}00014 TriangleMesh::TriangleMesh(\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& \_nTriangles, \textcolor{keyword}{const} \textcolor{keywordtype}{int}\& \_nVertices,}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00015}00015     \textcolor{keyword}{const} std::shared\_ptr<std::vector<int>>\& \_vertexIndices, \textcolor{keyword}{const} std::shared\_ptr<std::vector<Point3d>>\& \_p,}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00016}00016     \textcolor{keyword}{const} std::shared\_ptr<std::vector<Normal3d>>\& \_n, \textcolor{keyword}{const} std::shared\_ptr<std::vector<Vec3d>>\& \_s,}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00017}00017     \textcolor{keyword}{const} std::shared\_ptr<std::vector<Point2d>>\& \_uv, \textcolor{keyword}{const} std::shared\_ptr<Material>\& \_material) :}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00018}00018     nTriangles(\_nTriangles), nVertices(\_nVertices), vertexIndices(std::move(\_vertexIndices)), p(\_p), n(\_n), s(\_s), uv(\_uv), material(\_material)\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00019}00019 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00020}00020 Triangle::Triangle(\textcolor{keyword}{const} std::shared\_ptr<TriangleMesh>\& \_mesh, \textcolor{keyword}{const} \textcolor{keywordtype}{int}\& \_faceId): mesh(\_mesh), faceId(\_faceId)\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00021}00021     vertexId[0] = \_mesh-\/>vertexIndices-\/>at(\_faceId * 3);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00022}00022     vertexId[1] = \_mesh-\/>vertexIndices-\/>at(\_faceId * 3 + 1);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00023}00023     vertexId[2] = \_mesh-\/>vertexIndices-\/>at(\_faceId * 3 + 2);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00024}00024     material = mesh-\/>material;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00025}00025 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00026}00026 Triangle::Triangle(\textcolor{keyword}{const} std::vector<Point3d>\& points, \textcolor{keyword}{const} std::shared\_ptr<Material>\& \_material)\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00027}00027     assert(points.size() >= 3);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00028}00028     std::shared\_ptr<std::vector<Point3d>> p = std::make\_shared<std::vector<Point3d>>(points);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00029}00029     std::shared\_ptr<std::vector<int>> vertexIndices = std::make\_shared<std::vector<int>>(std::vector<int>(\{ 0, 1, 2 \}));}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00030}00030     mesh = std::make\_shared<TriangleMesh>(1, 3, vertexIndices, p, \textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, material);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00031}00031     material = \_material;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00032}00032     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) vertexId[i] = i;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00033}00033 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00034}00034 \textcolor{keywordtype}{void} Triangle::apply()}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00035}00035 \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00036}00036 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00037}00037 \textcolor{comment}{//@brief a simple version using barycentric coordinates to calculate the intersection}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00038}00038 \textcolor{comment}{//does not handle the case where ray and triangle fall in the same plane}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00039}00039 std::optional<Intersection> Triangle::intersect(\textcolor{keyword}{const} \mbox{\hyperlink{struct_ray}{Ray}}\& r)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00040}00040 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00041}00041     \mbox{\hyperlink{struct_t_point3}{Point3d}} p[3];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00042}00042     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) p[i] = mesh-\/>p-\/>at(i);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00043}00043 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00044}00044     \textcolor{comment}{//if parallel return nullptr}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00045}00045     \mbox{\hyperlink{struct_normal3d}{Normal3d}} geometryNormal = normalize(\mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(p[1] -\/ p[0], p[2] -\/ p[0]));}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00046}00046     \textcolor{keywordflow}{if} (fabs(dot(geometryNormal, r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}})) < 1e-\/8) \textcolor{keywordflow}{return} std::nullopt;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00047}00047 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00048}00048     \textcolor{comment}{//calculate barycentric coordinates(solve a system of three-\/variable linear equations): mul(A, X) = Y, based on Cramer's Rule}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00049}00049     \textcolor{comment}{//X[0] is alpha, X[1] is beta, X[2] is time}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00050}00050     std::vector<std::vector<double>> A(3, std::vector<double>(3)), transposeCofactorA(A);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00051}00051     std::vector<double> X(3), Y(3);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00052}00052     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00053}00053         A[i][0] = p[0][i] -\/ p[2][i];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00054}00054         A[i][1] = p[1][i] -\/ p[2][i];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00055}00055         A[i][2] = -\/r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}}[i];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00056}00056         Y[i] = r.\mbox{\hyperlink{struct_ray_abbb355c9e163124a0b4f8ab0f73643bb}{origin}}[i] -\/ p[2][i];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00057}00057     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00058}00058     \textcolor{comment}{//transpose of cofactor}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00059}00059     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} col = 0; col < 3; col++) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00060}00060         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} row = 0; row < 3; row++) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00061}00061             \textcolor{keyword}{auto} mod3 = [\&](\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& v) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00062}00062                 \textcolor{keywordflow}{return} v >= 3 ? v -\/ 3 : v;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00063}00063             \};}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00064}00064             transposeCofactorA[col][row] = A[mod3(row + 1)][mod3(col + 1)] * A[mod3(row + 2)][mod3(col + 2)] -\/ A[mod3(row + 1)][mod3(col + 2)] * A[mod3(row + 2)][mod3(col + 1)];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00065}00065         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00066}00066     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00067}00067 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00068}00068     \textcolor{comment}{//calculate X}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00069}00069     \textcolor{keywordtype}{double} det = A[0][0] * transposeCofactorA[0][0] + A[0][1] * transposeCofactorA[1][0] + A[0][2] * transposeCofactorA[2][0], invDet = 1.0 / det;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00070}00070     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00071}00071         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < 3; j++) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00072}00072             X[i] += transposeCofactorA[i][j] * Y[j];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00073}00073         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00074}00074         X[i] *= invDet;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00075}00075     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00076}00076     \textcolor{keywordflow}{if} (!(X[0] >= 0 \&\& X[0] <= 1) || !(X[1] >= 0 \&\& X[1] <= 1) || !(X[0] + X[1] <= 1) || !(X[2] >= r.\mbox{\hyperlink{struct_ray_aec34a0f56e84c5ea8e843ea51232f70a}{timeMin}} \&\& X[2] <= r.\mbox{\hyperlink{struct_ray_a56348eb670822e71de6c3e8a9ef31fc4}{timeMax}})) \textcolor{keywordflow}{return} std::nullopt;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00077}00077 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00078}00078     \textcolor{comment}{//calculate dpdu, dpdv}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00079}00079     \textcolor{keyword}{auto} getUVs = [\&](\mbox{\hyperlink{struct_t_point2}{Point2d}} uv[]) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00080}00080         \textcolor{keywordflow}{if} (mesh-\/>uv) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00081}00081             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) uv[i] = mesh-\/>uv-\/>at(vertexId[i]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00082}00082         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00083}00083         \textcolor{keywordflow}{else} \{\textcolor{comment}{//default settings}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00084}00084             uv[0] = \mbox{\hyperlink{struct_t_point2}{Point2d}}(0, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00085}00085             uv[1] = \mbox{\hyperlink{struct_t_point2}{Point2d}}(1, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00086}00086             uv[2] = \mbox{\hyperlink{struct_t_point2}{Point2d}}(1, 1);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00087}00087         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00088}00088     \};}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00089}00089     \mbox{\hyperlink{struct_t_vector3}{Vec3d}} dpdu, dpdv;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00090}00090     \mbox{\hyperlink{struct_t_point2}{Point2d}} uv[3];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00091}00091     getUVs(uv);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00092}00092     \mbox{\hyperlink{struct_t_vector2}{Vec2d}} duv02 = uv[0] -\/ uv[2], duv12 = uv[1] -\/ uv[2];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00093}00093     \mbox{\hyperlink{struct_t_vector3}{Vec3d}} dp02 = p[0] -\/ p[2], dp12 = p[1] -\/ p[2];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00094}00094     \textcolor{keywordtype}{double} uvDet = duv02[0] * duv12[1] -\/ duv02[1] * duv12[0];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00095}00095     \textcolor{keywordflow}{if} (fabs(uvDet) < 1e-\/8) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00096}00096         coordinateSystem(normalize(geometryNormal), dpdu, dpdv);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00097}00097     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00098}00098     \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00099}00099         \textcolor{keywordtype}{double} invDet = 1.0 / uvDet;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00100}00100         dpdu = (duv12[1] * dp02 -\/ duv02[1] * dp12) * invDet;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00101}00101         dpdv = (-\/duv12[0] * dp02 + duv02[0] * dp12) * invDet;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00102}00102     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00103}00103 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00104}00104     \textcolor{comment}{//get intersection, mostly refer to PBRT-\/V3}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00105}00105     Intersection its;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00106}00106     its.position = r.\mbox{\hyperlink{struct_ray_abbb355c9e163124a0b4f8ab0f73643bb}{origin}} + r.\mbox{\hyperlink{struct_ray_a317ee29d4f6213ede639f2f757f84784}{direction}} * X[2];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00107}00107     its.geometryNormal = geometryNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00108}00108     coordinateSystem(geometryNormal, its.geometryTangent, its.geometryBitangent);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00109}00109     its.uv = uv[0] * X[0] + uv[1] * X[1] + uv[2] * (1 -\/ X[0] -\/ X[1]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00110}00110     its.dpdu = dpdu, its.dpdv = dpdv;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00111}00111     its.shFrame = \mbox{\hyperlink{struct_frame}{Frame}}(geometryNormal);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00112}00112     its.material = material;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00113}00113     its.object = \textcolor{keyword}{this};}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00114}00114     \textcolor{keywordflow}{if} (mesh-\/>n || mesh-\/>s) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00115}00115         \mbox{\hyperlink{struct_normal3d}{Normal3d}} shadingNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00116}00116         \textcolor{keywordflow}{if} (mesh-\/>n) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00117}00117             shadingNormal = mesh-\/>n-\/>at(vertexId[0]) * X[0] + mesh-\/>n-\/>at(vertexId[1]) * X[1] + mesh-\/>n-\/>at(vertexId[2]) * (1 -\/ X[0] -\/ X[1]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00118}00118             \textcolor{keywordflow}{if} (shadingNormal.length2() > 0) shadingNormal = normalize(shadingNormal);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00119}00119             \textcolor{keywordflow}{else} shadingNormal = geometryNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00120}00120         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00121}00121         \textcolor{keywordflow}{else} shadingNormal = geometryNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00122}00122 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00123}00123         \mbox{\hyperlink{struct_normal3d}{Normal3d}} shadingTangent;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00124}00124         \textcolor{keywordflow}{if} (mesh-\/>s) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00125}00125             shadingTangent = mesh-\/>s-\/>at(vertexId[0]) * X[0] + mesh-\/>s-\/>at(vertexId[1]) * X[1] + mesh-\/>s-\/>at(vertexId[2]) * (1 -\/ X[0] -\/ X[1]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00126}00126             \textcolor{keywordflow}{if} (shadingTangent.length2() > 0) shadingTangent = normalize(shadingTangent);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00127}00127             \textcolor{keywordflow}{else} shadingTangent = normalize(its.dpdu);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00128}00128         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00129}00129         \textcolor{keywordflow}{else} shadingTangent = normalize(its.dpdu);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00130}00130 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00131}00131         \mbox{\hyperlink{struct_normal3d}{Normal3d}} shadingBitangent = \mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(shadingTangent, shadingNormal);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00132}00132         \textcolor{keywordflow}{if} (shadingBitangent.length2() > 0) shadingBitangent = normalize(shadingBitangent), shadingTangent = \mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(shadingBitangent, shadingNormal);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00133}00133         \textcolor{keywordflow}{else} coordinateSystem(shadingNormal, shadingTangent, shadingBitangent);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00134}00134         its.shFrame = \mbox{\hyperlink{struct_frame}{Frame}}(shadingTangent, shadingBitangent, shadingNormal);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00135}00135 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00136}00136         \mbox{\hyperlink{struct_normal3d}{Normal3d}} dndu, dndv;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00137}00137         \textcolor{keywordflow}{if} (mesh-\/>n) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00138}00138             \mbox{\hyperlink{struct_t_vector2}{Vec2d}} duv02 = uv[0] -\/ uv[2], duv12 = uv[1] -\/ uv[2];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00139}00139             \mbox{\hyperlink{struct_normal3d}{Normal3d}} dn02 = mesh-\/>n-\/>at(vertexId[0]) -\/ mesh-\/>n-\/>at(vertexId[2]), dn12 = mesh-\/>n-\/>at(vertexId[1]) -\/ mesh-\/>n-\/>at(vertexId[2]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00140}00140             \textcolor{keywordtype}{double} uvDet = duv02[0] * duv12[1] -\/ duv02[1] * duv12[0];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00141}00141             \textcolor{keywordflow}{if} (fabs(uvDet) < 1e-\/8) \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00142}00142                 \mbox{\hyperlink{struct_t_vector3}{Vec3d}} dn = \mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(\mbox{\hyperlink{struct_t_vector3}{Vec3d}}(mesh-\/>n-\/>at(vertexId[2]) -\/ mesh-\/>n-\/>at(vertexId[0])),}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00143}00143                     \mbox{\hyperlink{struct_t_vector3}{Vec3d}}(mesh-\/>n-\/>at(vertexId[1]) -\/ mesh-\/>n-\/>at(vertexId[0])));}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00144}00144                 \textcolor{keywordflow}{if} (dn.length2() == 0)}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00145}00145                     dndu = dndv = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(0, 0, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00146}00146                 \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00147}00147                     \mbox{\hyperlink{struct_t_vector3}{Vec3d}} dnu, dnv;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00148}00148                     coordinateSystem(dn, dnu, dnv);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00149}00149                     dndu = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(dnu);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00150}00150                     dndv = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(dnv);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00151}00151                 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00152}00152             \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00153}00153             \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00154}00154                 dndu = dndv = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(0, 0, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00155}00155             \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00156}00156         \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00157}00157         \textcolor{keywordflow}{else} dndu = dndv = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(0, 0, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00158}00158         its.dndu = dndu;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00159}00159         its.dndv = dndv;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00160}00160     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00161}00161     \textcolor{keywordflow}{else} its.dndu = its.dndv = \mbox{\hyperlink{struct_normal3d}{Normal3d}}(0, 0, 0);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00162}00162     \textcolor{keywordflow}{return} std::make\_optional(its);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00163}00163 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00164}00164 Intersection Triangle::sample(\textcolor{keyword}{const} \mbox{\hyperlink{struct_t_point2}{Point2d}}\& positionSample)\textcolor{keyword}{ const}\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00165}00165     \textcolor{keywordtype}{double} b[3];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00166}00166     b[0] = positionSample[0], b[1] = positionSample[1], b[2] = 1 -\/ b[0] -\/ b[1];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00167}00167     \mbox{\hyperlink{struct_t_point3}{Point3d}} p[3];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00168}00168     \mbox{\hyperlink{struct_normal3d}{Normal3d}} n[3];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00169}00169     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; i++) p[i] = mesh-\/>p-\/>at(vertexId[i]), n[i] = mesh-\/>n-\/>at(vertexId[i]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00170}00170     \mbox{\hyperlink{struct_normal3d}{Normal3d}} geometryNormal = normalize(\mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(p[1] -\/ p[0], p[2] -\/ p[0]));}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00171}00171     Intersection its;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00172}00172     its.position = p[0] * b[0] + p[1] * b[1] + p[2] * b[2];}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00173}00173     its.geometryNormal = geometryNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00174}00174     \textcolor{keywordflow}{if} (mesh-\/>n) \{\textcolor{comment}{//make the normal forward}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00175}00175         \mbox{\hyperlink{struct_normal3d}{Normal3d}} shadingNormal = normalize(n[0] * b[0] + n[1] * b[1] + n[2] * b[2]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00176}00176         \textcolor{keywordflow}{if} (dot(geometryNormal, shadingNormal) < 0) its.geometryNormal = -\/its.geometryNormal;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00177}00177     \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00178}00178     \textcolor{keywordflow}{return} its;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00179}00179 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00180}00180 }
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00181}00181 \textcolor{keywordtype}{void} Triangle::setLight(std::shared\_ptr<Light> light)}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00182}00182 \{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00183}00183     lightPtr = light;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00184}00184 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00185}00185 std::shared\_ptr<Light> Triangle::getLight()\textcolor{keyword}{ const}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00186}00186 \textcolor{keyword}{}\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00187}00187     \textcolor{keywordflow}{return} lightPtr;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00188}00188 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00189}00189 \textcolor{keywordtype}{double} Triangle::area()\textcolor{keyword}{ const}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00190}00190 \textcolor{keyword}{}\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00191}00191     \textcolor{keyword}{const} \mbox{\hyperlink{struct_t_point3}{Point3d}}\& p0 = mesh-\/>p-\/>at(vertexId[0]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00192}00192     \textcolor{keyword}{const} \mbox{\hyperlink{struct_t_point3}{Point3d}}\& p1 = mesh-\/>p-\/>at(vertexId[1]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00193}00193     \textcolor{keyword}{const} \mbox{\hyperlink{struct_t_point3}{Point3d}}\& p2 = mesh-\/>p-\/>at(vertexId[2]);}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00194}00194     \textcolor{keywordflow}{return} 0.5 * \mbox{\hyperlink{vector_8h_ab82aa209c23c60f76558d0d672e5cd8e}{cross}}(p1 -\/ p0, p2 -\/ p0).length();}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00195}00195 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00196}00196 \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}} Triangle::WorldBound()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00197}00197     \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}} result;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00198}00198     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 3; i++) result = \mbox{\hyperlink{_bounding_box_8h_a70e5ea0119706a75a45a00bfeeeaa9f5}{BoundingBoxUnion}}(result, \mbox{\hyperlink{class_bounding_box3}{BoundingBox3f}}(mesh-\/>p-\/>at(vertexId[i])));}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00199}00199     \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00200}00200 \}}
\DoxyCodeLine{\Hypertarget{_triangle_8cpp_source_l00201}00201 }

\end{DoxyCode}
